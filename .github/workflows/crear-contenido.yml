name: Crear Contenido desde Issue

on:
  issues:
    types: [opened]

# ============================================================================
# CONFIGURACIÓN
# ============================================================================
env:
  # Usuarios autorizados para crear contenido (separados por coma)
  AUTHORIZED_USERS: "Chemaclass,CLIENT_USERNAME_HERE"

  # Claude model for translations. Options:
  # - claude-3-5-haiku-20241022 (fastest, cheapest)
  # - claude-3-5-sonnet-20241022 (balanced)
  # - claude-3-opus-20240229 (best quality)
  # See: https://docs.anthropic.com/en/docs/about-claude/models
  CLAUDE_MODEL: "claude-3-5-haiku-20241022"

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  create-content:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'nuevo-articulo') || contains(github.event.issue.labels.*.name, 'nueva-investigacion') || contains(github.event.issue.labels.*.name, 'nuevo-trabajo') || contains(github.event.issue.labels.*.name, 'nueva-publicacion')

    steps:
      - name: Check authorized user
        id: auth
        run: |
          AUTHOR="${{ github.event.issue.user.login }}"
          if [[ ",$AUTHORIZED_USERS," == *",$AUTHOR,"* ]]; then
            echo "authorized=true" >> $GITHUB_OUTPUT
            echo "User $AUTHOR is authorized"
          else
            echo "authorized=false" >> $GITHUB_OUTPUT
            echo "User $AUTHOR is NOT authorized"
          fi

      - name: Reject unauthorized user
        if: steps.auth.outputs.authorized == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `❌ **No autorizado**\n\nLo siento, solo usuarios autorizados pueden crear contenido a traves de este formulario.`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
            core.setFailed('User not authorized');

      - name: Checkout
        if: steps.auth.outputs.authorized == 'true'
        uses: actions/checkout@v4

      - name: Parse issue and create content
        id: create
        if: steps.auth.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { createContent } = require('./.github/scripts/content-creator.js');
            const fs = require('fs');

            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            const result = createContent(issue.body, labels);

            fs.writeFileSync(result.filename, result.content);
            console.log(`Created: ${result.filename}`);

            core.setOutput('filename', result.filename);
            core.setOutput('title', result.title);
            core.setOutput('content_type', result.contentType);

      - name: Translate to EN and IT
        if: steps.auth.outputs.authorized == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        uses: actions/github-script@v7
        with:
          script: |
            const { translateAndSave } = require('./.github/scripts/translator.js');
            const fs = require('fs');

            const filename = '${{ steps.create.outputs.filename }}';
            const model = '${{ env.CLAUDE_MODEL }}';

            if (!process.env.ANTHROPIC_API_KEY) {
              console.log('ANTHROPIC_API_KEY not set, skipping translations');
              return;
            }

            try {
              console.log(`Using model: ${model}`);
              await translateAndSave(filename, 'en', process.env.ANTHROPIC_API_KEY, fs, model);
              await translateAndSave(filename, 'it', process.env.ANTHROPIC_API_KEY, fs, model);
              console.log('Translations completed successfully');
            } catch (error) {
              console.error('Translation failed:', error.message);
              console.log('Continuing without translations...');
            }

      - name: Commit and push
        id: commit
        if: steps.auth.outputs.authorized == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add content/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "feat: add new content from issue #${{ github.event.issue.number }}"
            git push
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger build workflow
        if: steps.auth.outputs.authorized == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'main.yml',
              ref: 'main'
            });

      - name: Close issue with comment
        if: steps.auth.outputs.authorized == 'true' && steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `✅ **Contenido creado correctamente**\n\nEl contenido se ha publicado en ES, EN e IT, y estara disponible en la web en unos minutos.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Already processed
        if: steps.auth.outputs.authorized == 'true' && steps.commit.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Issue already processed, no new content to create');
